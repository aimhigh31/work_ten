const { Client } = require('pg');
require('dotenv').config({ path: '.env.local' });

// Supabase URLì—ì„œ PostgreSQL ì—°ê²° ì •ë³´ ì¶”ì¶œ
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const projectRef = supabaseUrl.match(/https:\/\/([^.]+)/)[1];

const client = new Client({
  host: `aws-0-ap-northeast-2.pooler.supabase.com`,
  port: 6543,
  database: 'postgres',
  user: 'postgres.clokvlauaznlvpxzrzzy',
  password: process.env.SUPABASE_DB_PASSWORD,
  ssl: { rejectUnauthorized: false }
});

async function recreateTable() {
  try {
    await client.connect();
    console.log('âœ… PostgreSQL ì—°ê²° ì„±ê³µ');

    // 1. ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ
    console.log('\nğŸ—‘ï¸ ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ ì¤‘...');
    await client.query(`DROP TABLE IF EXISTS main_task_data CASCADE;`);
    console.log('âœ… ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ ì™„ë£Œ');

    // 2. int4 idë¡œ ìƒˆ í…Œì´ë¸” ìƒì„±
    console.log('\nğŸ”¨ int4 idë¡œ ìƒˆ í…Œì´ë¸” ìƒì„± ì¤‘...');
    const createTableSQL = `
      CREATE TABLE main_task_data (
        id int4 GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        code varchar(100) UNIQUE NOT NULL,
        registration_date date,
        start_date date,
        completed_date date,
        department varchar(100),
        work_content text,
        description text,
        team varchar(100),
        assignee_id uuid,
        assignee_name varchar(100),
        progress int4 DEFAULT 0,
        status varchar(50) DEFAULT 'ëŒ€ê¸°',
        is_active boolean DEFAULT true,
        created_at timestamptz DEFAULT now(),
        updated_at timestamptz DEFAULT now()
      );
    `;

    await client.query(createTableSQL);
    console.log('âœ… ìƒˆ í…Œì´ë¸” ìƒì„± ì™„ë£Œ (id: int4)');

    // 3. ì¸ë±ìŠ¤ ìƒì„±
    console.log('\nğŸ“Š ì¸ë±ìŠ¤ ìƒì„± ì¤‘...');
    await client.query(`CREATE INDEX idx_main_task_code ON main_task_data(code);`);
    await client.query(`CREATE INDEX idx_main_task_status ON main_task_data(status);`);
    await client.query(`CREATE INDEX idx_main_task_team ON main_task_data(team);`);
    await client.query(`CREATE INDEX idx_main_task_is_active ON main_task_data(is_active);`);
    console.log('âœ… ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ');

    // 4. RLS ì •ì±… ì„¤ì •
    console.log('\nğŸ”’ RLS ì •ì±… ì„¤ì • ì¤‘...');
    await client.query(`ALTER TABLE main_task_data ENABLE ROW LEVEL SECURITY;`);
    await client.query(`
      CREATE POLICY "ëª¨ë“  ì‚¬ìš©ìê°€ ì¡°íšŒ ê°€ëŠ¥"
      ON main_task_data FOR SELECT
      USING (true);
    `);
    await client.query(`
      CREATE POLICY "ëª¨ë“  ì‚¬ìš©ìê°€ ì‚½ì… ê°€ëŠ¥"
      ON main_task_data FOR INSERT
      WITH CHECK (true);
    `);
    await client.query(`
      CREATE POLICY "ëª¨ë“  ì‚¬ìš©ìê°€ ìˆ˜ì • ê°€ëŠ¥"
      ON main_task_data FOR UPDATE
      USING (true);
    `);
    await client.query(`
      CREATE POLICY "ëª¨ë“  ì‚¬ìš©ìê°€ ì‚­ì œ ê°€ëŠ¥"
      ON main_task_data FOR DELETE
      USING (true);
    `);
    console.log('âœ… RLS ì •ì±… ì„¤ì • ì™„ë£Œ');

    // 5. í…Œì´ë¸” ì •ë³´ í™•ì¸
    console.log('\nğŸ“‹ í…Œì´ë¸” ì •ë³´ í™•ì¸...');
    const result = await client.query(`
      SELECT column_name, data_type, is_nullable, column_default
      FROM information_schema.columns
      WHERE table_name = 'main_task_data'
      ORDER BY ordinal_position;
    `);

    console.log('\nâœ… main_task_data í…Œì´ë¸” ì»¬ëŸ¼ ì •ë³´:');
    result.rows.forEach(row => {
      console.log(`  - ${row.column_name}: ${row.data_type} ${row.is_nullable === 'NO' ? 'NOT NULL' : ''} ${row.column_default || ''}`);
    });

    console.log('\nâœ… í…Œì´ë¸” ì¬ìƒì„± ì™„ë£Œ!');
    console.log('âœ… id íƒ€ì…: int4 (auto-increment)');

  } catch (error) {
    console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
    throw error;
  } finally {
    await client.end();
    console.log('\nâœ… ì—°ê²° ì¢…ë£Œ');
  }
}

recreateTable();
