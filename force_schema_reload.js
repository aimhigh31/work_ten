const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.local' });

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);

async function forceSchemaReload() {
  console.log('ğŸ”„ Supabase ìŠ¤í‚¤ë§ˆ ê°•ì œ ìƒˆë¡œê³ ì¹¨...');

  try {
    // 1. PostgreSQL í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œ ìŠ¤í‚¤ë§ˆ ìƒˆë¡œê³ ì¹¨
    console.log('ğŸ“ PostgreSQL ìŠ¤í‚¤ë§ˆ ìƒˆë¡œê³ ì¹¨...');
    const reloadResult = await supabase.rpc('exec', {
      sql: `
        -- ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì•Œë¦¼
        NOTIFY pgrst, 'reload schema';

        -- ì—°ê²° í’€ ìƒˆë¡œê³ ì¹¨
        SELECT pg_reload_conf();

        -- í˜„ì¬ ì—°ê²°ëœ ì„¸ì…˜ í™•ì¸
        SELECT datname, usename, application_name, state
        FROM pg_stat_activity
        WHERE datname = current_database()
        LIMIT 5;
      `
    });

    if (reloadResult.error) {
      console.error('âŒ PostgreSQL ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', reloadResult.error);
    } else {
      console.log('âœ… PostgreSQL ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
    }

    // 2. í…Œì´ë¸” ì¬ìƒì„± (ë‹¤ë¥¸ ë°©ì‹)
    console.log('ğŸ“ í…Œì´ë¸” ì¬ìƒì„±...');
    const recreateResult = await supabase.rpc('exec', {
      sql: `
        -- ì™„ì „ ì‚­ì œ
        DROP TABLE IF EXISTS it_hardware_data CASCADE;

        -- ì¦‰ì‹œ ì¬ìƒì„±
        CREATE TABLE it_hardware_data (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          registration_date DATE NOT NULL DEFAULT CURRENT_DATE,
          code VARCHAR(50) UNIQUE NOT NULL,
          team VARCHAR(100),
          department VARCHAR(100),
          work_content TEXT,
          status VARCHAR(50) DEFAULT 'ì˜ˆë¹„',
          assignee VARCHAR(100),
          start_date DATE,
          completed_date DATE,
          attachments TEXT[],
          asset_category VARCHAR(100),
          asset_name VARCHAR(200),
          model VARCHAR(200),
          manufacturer VARCHAR(200),
          vendor VARCHAR(200),
          detail_spec TEXT,
          purchase_date DATE,
          warranty_end_date DATE,
          serial_number VARCHAR(200),
          current_user VARCHAR(100),
          location VARCHAR(200),
          images TEXT[],
          is_active BOOLEAN DEFAULT true,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW(),
          created_by VARCHAR(100) DEFAULT 'user',
          updated_by VARCHAR(100) DEFAULT 'user'
        );

        -- ëª¨ë“  ê¶Œí•œ ë¶€ì—¬
        GRANT ALL ON it_hardware_data TO postgres, authenticated, anon, service_role;

        -- RLS ë¹„í™œì„±í™” (ì¼ë‹¨ í…ŒìŠ¤íŠ¸ìš©)
        ALTER TABLE it_hardware_data DISABLE ROW LEVEL SECURITY;

        -- ìƒ˜í”Œ ë°ì´í„°
        INSERT INTO it_hardware_data (
          code, team, department, work_content, status, assignee, start_date,
          asset_category, asset_name, model, manufacturer, vendor, detail_spec,
          purchase_date, warranty_end_date, serial_number, current_user, location, registration_date
        ) VALUES
        ('HW-25-001', 'ê°œë°œíŒ€', 'IT', 'Dell OptiPlex 3090', 'ì‚¬ìš©', 'ê¹€ë¯¼ìˆ˜', '2025-01-15',
         'ë°ìŠ¤í¬í†±', 'Dell OptiPlex 3090', 'OptiPlex 3090', 'Dell', 'Dell ì½”ë¦¬ì•„', 'Intel Core i5-11500, 8GB RAM, 256GB SSD',
         '2025-01-10', '2028-01-10', 'DL3090001', 'ê¹€ë¯¼ìˆ˜', 'ITì‹¤-A101', '2025-01-15'),
        ('HW-25-002', 'ë””ìì¸íŒ€', 'IT', 'MacBook Pro 14ì¸ì¹˜', 'ì‚¬ìš©', 'ì´ì˜í¬', '2025-01-10',
         'ë…¸íŠ¸ë¶', 'MacBook Pro 14ì¸ì¹˜', 'MacBook Pro 14 (M2)', 'Apple', 'Apple ì½”ë¦¬ì•„', 'Apple M2, 16GB RAM, 512GB SSD',
         '2025-01-08', '2026-01-08', 'MBA14002', 'ì´ì˜í¬', 'ë””ìì¸ì‹¤-B201', '2025-01-10'),
        ('HW-25-003', 'ITíŒ€', 'IT', 'HP ProLiant ML350', 'ì‚¬ìš©', 'ë°•ì§€í›ˆ', '2025-01-20',
         'ì„œë²„', 'HP ProLiant ML350', 'ProLiant ML350 Gen10', 'HP', 'HP ì½”ë¦¬ì•„', 'Intel Xeon Silver 4214, 32GB RAM, 2TB HDD',
         '2025-01-18', '2028-01-18', 'HP350003', 'ë°•ì§€í›ˆ', 'ì„œë²„ì‹¤-C301', '2025-01-20');

        -- ê²°ê³¼ ë°˜í™˜
        SELECT 'Table created successfully' as result, COUNT(*) as row_count FROM it_hardware_data;
      `
    });

    if (recreateResult.error) {
      console.error('âŒ í…Œì´ë¸” ì¬ìƒì„± ì‹¤íŒ¨:', recreateResult.error);
    } else {
      console.log('âœ… í…Œì´ë¸” ì¬ìƒì„± ì™„ë£Œ:', recreateResult.data);
    }

    // 3. ê¸¸ê²Œ ëŒ€ê¸° í›„ í…ŒìŠ¤íŠ¸
    console.log('ğŸ“ ìŠ¤í‚¤ë§ˆ ìºì‹œ ì—…ë°ì´íŠ¸ ëŒ€ê¸° (10ì´ˆ)...');
    await new Promise(resolve => setTimeout(resolve, 10000));

    // 4. REST API í…ŒìŠ¤íŠ¸
    console.log('ğŸ“ REST API ìµœì¢… í…ŒìŠ¤íŠ¸...');
    const { data: finalData, error: finalError } = await supabase
      .from('it_hardware_data')
      .select('*')
      .limit(3);

    if (finalError) {
      console.error('âŒ REST API ìµœì¢… í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', finalError);

      // PostgREST ìŠ¤í‚¤ë§ˆ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì‹œë„
      console.log('ğŸ“ PostgREST ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì‹œë„...');
      try {
        const response = await fetch(`${process.env.NEXT_PUBLIC_SUPABASE_URL}/rest/v1/`, {
          method: 'GET',
          headers: {
            'apikey': process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`,
          }
        });
        console.log('ğŸ”„ PostgREST ì‘ë‹µ ìƒíƒœ:', response.status);
      } catch (e) {
        console.log('âš ï¸ PostgREST ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', e.message);
      }

    } else {
      console.log('âœ… REST API ìµœì¢… í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
      console.log('ğŸ“Š ì¡°íšŒëœ ë°ì´í„°:', finalData?.map(d => ({ code: d.code, asset_name: d.asset_name })));
    }

    console.log('ğŸ‰ ìŠ¤í‚¤ë§ˆ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!');

  } catch (error) {
    console.error('âŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
  }
}

forceSchemaReload();